name: Copilot Setup Steps

permissions:
  contents: read

# This workflow sets up the Copilot coding agent's environment before it starts
# working on a task.  Steps here run BEFORE the firewall is enabled, so all
# network downloads (npm packages, Playwright browsers) must happen here.
#
# The job must be named `copilot-setup-steps` and triggered by `workflow_dispatch`.
# See: https://docs.github.com/en/copilot/customizing-copilot/customizing-the-development-environment-for-copilot-coding-agent

on:
  workflow_dispatch:

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    # Use the same Playwright container as playwright-e2e.yml so that the
    # Copilot agent runs in an identical environment to CI — fonts, system
    # libraries, and browser rendering are consistent, which ensures visual
    # snapshot baselines generated by the agent match what CI produces.
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install

      # Install both Chromium (desktop/pixel) and WebKit (tablet/iPhone) so the
      # agent can run either CI shard locally without hitting the firewall.
      # Each browser uses the same cache key format as playwright-e2e.yml so that
      # Copilot setup and CI share the same browser binary cache entries.
      # System deps are already in the container image — browser binaries only.
      - name: Cache Playwright chromium
        id: cache-chromium
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-v1.58.2-noble-chromium-${{ hashFiles('yarn.lock') }}

      - name: Cache Playwright webkit
        id: cache-webkit
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-v1.58.2-noble-webkit-${{ hashFiles('yarn.lock') }}

      - name: Install Playwright chromium (cache miss)
        if: steps.cache-chromium.outputs.cache-hit != 'true'
        run: npx playwright install chromium

      - name: Install Playwright webkit (cache miss)
        if: steps.cache-webkit.outputs.cache-hit != 'true'
        run: npx playwright install webkit

      # Pre-build the app so `vite preview` (used by E2E tests) is ready to serve
      # immediately — the agent doesn't need to rebuild before running E2E tests.
      - name: Build app
        run: yarn build
