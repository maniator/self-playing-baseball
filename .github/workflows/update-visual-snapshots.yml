name: Update Visual Snapshots

# Manually triggered workflow to regenerate committed visual snapshot baselines
# from inside the same Playwright container used by playwright-e2e.yml.
#
# Snapshots MUST be generated here (or in playwright-e2e.yml) to ensure they
# match the exact rendering environment used by CI. Never commit snapshots
# generated outside this container — font and rendering differences will cause
# spurious failures.
#
# Run this whenever:
#  - The container image version changes (font/rendering environment changes)
#  - An intentional UI change requires new baselines (visual.spec.ts)
#  - The game layout changes (layout.spec.ts)
#
# Usage: Actions → "Update Visual Snapshots" → Run workflow → select branch

on:
  workflow_dispatch:
  push:
    branches:
      - "copilot/implement-batter-details-inspector"

# Cancel any in-progress or queued run for the same ref when a new push lands,
# so that stale queued runs don't overwrite snapshots generated by newer code.
concurrency:
  group: update-visual-snapshots-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-snapshots:
    name: Update snapshots (${{ matrix.browser }})
    runs-on: ubuntu-latest
    # Same container as playwright-e2e.yml — ensures baselines match CI rendering.
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
    permissions:
      contents: write

    strategy:
      fail-fast: false
      max-parallel: 1  # serialize commits to avoid push conflicts between browser shards
      matrix:
        include:
          - browser: chromium
            projects: >-
              --project=determinism
              --project=desktop
              --project=pixel-7
              --project=pixel-5
          - browser: webkit
            projects: >-
              --project=tablet
              --project=iphone-15-pro-max
              --project=iphone-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Use a token that can push back to the branch
          token: ${{ secrets.GITHUB_TOKEN }}

      # actions/checkout marks safe.directory with a temporary HOME override that
      # is invisible to subsequent steps running inside the container.  Re-adding
      # it here (with the real container HOME) makes every subsequent git command
      # work correctly, including the snapshot commit/push steps and Husky.
      - name: Mark workspace as safe git directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install

      # Browser binaries are pre-installed in the container at /ms-playwright.
      - name: Build app
        run: yarn build

      - name: Update visual snapshots
        run: npx playwright test ${{ matrix.projects }} --update-snapshots
        env:
          CI: true

      - name: Commit updated snapshots
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update snapshots for ${{ matrix.browser }} [skip ci]"
          file_pattern: "e2e/tests/visual.spec.ts-snapshots/ e2e/tests/layout.spec.ts-snapshots/"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
