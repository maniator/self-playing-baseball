name: Update Visual Snapshots

# Regenerates committed visual snapshot baselines from inside the same
# Playwright container used by playwright-e2e.yml.
#
# Snapshots MUST be generated here (or in playwright-e2e.yml) to ensure they
# match the exact rendering environment used by CI.  Never commit snapshots
# generated outside this container — font and rendering differences will cause
# spurious failures.
#
# AUTO-TRIGGER: Fires on every push to any non-master branch (covers spec
# changes, component changes, and anything else that could affect rendering).
#
# MANUAL TRIGGER: Actions → "Update Visual Snapshots" → Run workflow → branch
#
# Run this whenever:
#  - The container image version changes (font/rendering environment changes)
#  - An intentional UI change requires new baselines (e2e/tests/visual/)
#  - The game layout changes (layout.spec.ts)

on:
  workflow_dispatch:
  push:
    branches-ignore:
      - master

# Cancel any in-progress or queued run for the same ref when a new push lands,
# so that stale runs don't overwrite snapshots generated by newer code.
concurrency:
  group: update-visual-snapshots-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-snapshots:
    name: Update snapshots (${{ matrix.browser }})
    runs-on: ubuntu-latest
    # Same container as playwright-e2e.yml — ensures baselines match CI rendering.
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
    permissions:
      contents: write

    strategy:
      fail-fast: false
      max-parallel: 1  # serialize commits to avoid push conflicts between browser shards
      matrix:
        include:
          - browser: chromium
            projects: >-
              --project=desktop
              --project=pixel-7
              --project=pixel-5
          - browser: webkit
            projects: >-
              --project=tablet
              --project=iphone-15-pro-max
              --project=iphone-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Use a token that can push back to the branch
          token: ${{ secrets.GITHUB_TOKEN }}

      # actions/checkout marks safe.directory with a temporary HOME override that
      # is invisible to subsequent steps running inside the container.  Re-adding
      # it here (with the real container HOME) makes every subsequent git command
      # work correctly, including the snapshot commit/push steps and Husky.
      - name: Mark workspace as safe git directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install

      # Browser binaries are pre-installed in the container at /ms-playwright.
      - name: Build app
        run: yarn build

      - name: Update visual snapshots
        run: npx playwright test e2e/tests/visual/ e2e/tests/layout.spec.ts ${{ matrix.projects }} --update-snapshots
        env:
          CI: true

      - name: Commit updated snapshots
        id: commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update snapshots for ${{ matrix.browser }}"
          file_pattern: "e2e/tests/visual/ e2e/tests/layout.spec.ts-snapshots/"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com

  # GitHub blocks GITHUB_TOKEN pushes from triggering pull_request/push
  # workflow runs (loop prevention). After all matrix snapshot jobs finish,
  # check whether any snapshots were actually committed and, if so, explicitly
  # dispatch playwright-e2e.yml so it validates the fresh baselines.
  trigger-e2e:
    name: Trigger E2E validation
    needs: update-snapshots
    if: always() && needs.update-snapshots.result != 'cancelled' && needs.update-snapshots.result != 'skipped'
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 1

      # The matrix jobs may have pushed new snapshot commits after this workflow
      # was triggered.  Pull to get the latest state of the branch before
      # checking whether a snapshot update commit was made.
      - name: Pull latest commits from branch
        run: git pull --ff-only origin "${{ github.ref_name }}"

      - name: Check if snapshots were updated
        id: check
        run: |
          LAST_MSG=$(git log -1 --pretty=%s)
          if echo "$LAST_MSG" | grep -q "^chore: update snapshots"; then
            echo "snapshots_updated=true" >> "$GITHUB_OUTPUT"
          else
            echo "snapshots_updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Dispatch playwright-e2e workflow
        if: steps.check.outputs.snapshots_updated == 'true'
        run: gh workflow run playwright-e2e.yml --ref "${{ github.ref_name }}" --repo "${{ github.repository }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
